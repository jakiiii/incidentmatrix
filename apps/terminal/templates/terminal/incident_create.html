{% extends 'base.html' %}
{% load static %}
{% load countries %}
{% get_countries as countries %}
{% block title %}{{ title }} || {{ block.super }}{% endblock title %}


{% block content %}
    {% if form.country.errors %}
        <div class="invalid-feedback d-block">
            {{ form.country.errors|striptags }}
        </div>
    {% endif %}
    {% if form.errors %}
        <div class="alert alert-danger">
            <ul class="mb-0">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="mt-0 header-title">{{ title }}</h4>
                    <hr/>

                    <form method="post" enctype="multipart/form-data" id="incidentCreateForm">
                        {% csrf_token %}

                        <!-- Country -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">রাষ্ট্র/দেশ</label>
                            <div class="col-sm-10">
                                {{ form.country }}
                                {% for e in form.country.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- State (non-BD) -->
                        <div class="form-group row" id="wrap_state">
                            <label class="col-sm-2 col-form-label">স্টেট/রাজ্য</label>
                            <div class="col-sm-10">
                                {{ form.state }}
                                {% for e in form.state.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Division (BD only) -->
                        <div class="form-group row" id="wrap_division">
                            <label class="col-sm-2 col-form-label">বিভাগের নাম</label>
                            <div class="col-sm-10">
                                {{ form.division }}
                                {% for e in form.division.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- District -->
                        <div class="form-group row" id="wrap_district">
                            <label class="col-sm-2 col-form-label">জেলার নাম</label>
                            <div class="col-sm-10">
                                {{ form.district }}
                                {% for e in form.district.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Subdistrict -->
                        <div class="form-group row" id="wrap_subdistrict">
                            <label class="col-sm-2 col-form-label">উপজেলার নাম</label>
                            <div class="col-sm-10">
                                {{ form.subdistrict }}
                                {% for e in form.subdistrict.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Title -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">শিরনাম</label>
                            <div class="col-sm-10">
                                {{ form.title }}
                                {% for e in form.title.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Incident type -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">ঘটনার ধরণ</label>
                            <div class="col-sm-10">
                                {{ form.incident_type }}
                                {% for e in form.incident_type.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Involved actor -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">জড়িত ব্যক্তি/গোষ্ঠী/সংগঠন</label>
                            <div class="col-sm-10">
                                {{ form.involved_actor }}
                                {% for e in form.involved_actor.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Lat/Lng -->
                        <!-- Lat/Lng -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">অক্ষাংশ (ল্যাটিচুয়েড)</label>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    {{ form.latitude }}
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" id="btnUseMyLocation">
                                            Use my location
                                        </button>
                                        <button type="button" class="btn btn-outline-info" data-toggle="modal"
                                                data-target="#mapPickerModal">Pick on map
                                        </button>
                                    </div>
                                </div>
                                {% for e in form.latitude.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">দ্রাঘিমাংশ (লংগিচুয়েড)</label>
                            <div class="col-sm-10">
                                {{ form.longitude }}
                                {% for e in form.longitude.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Map Picker Modal (Bootstrap) -->
                        <div class="modal fade" id="mapPickerModal" tabindex="-1" role="dialog"
                             aria-labelledby="mapPickerModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="mapPickerModalLabel">Pick location on map</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Optional place search -->
                                        <div class="form-group">
                                            <input id="placeSearch" class="form-control" type="text"
                                                   placeholder="Search a place...">
                                        </div>
                                        <div id="mapPicker" style="width:100%; height: 420px;"></div>
                                        <small class="text-muted d-block mt-2">Click the map to place/move the
                                            marker.</small>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" id="btnUseSelectedPoint" class="btn btn-primary"
                                                data-dismiss="modal">Use selected point
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date/time -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">ঘটনার তারিখ এবং সুময়</label>
                            <div class="col-sm-10">
                                {{ form.date }}
                                {% for e in form.date.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label">বিস্তারিত</label>
                            <div class="col-sm-10">
                                {{ form.description }}
                                {% for e in form.description.errors %}
                                    <div class="text-danger">{{ e }}</div>{% endfor %}
                            </div>
                        </div>

                        {% if existing_images %}
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">বর্তমান ছবি</label>
                                <div class="col-sm-10">
                                    <div class="d-flex flex-wrap gap-3">
                                        {% for img in existing_images %}
                                            <label class="border rounded p-2 d-inline-block text-center">
                                                <img src="{{ img.image.url }}" alt=""
                                                     style="width:120px;height:120px;object-fit:cover;display:block;margin-bottom:6px;">
                                                <input type="checkbox" name="delete_images" value="{{ img.id }}"> মুছে
                                                ফেলুন
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">ছবি</label>
                                <div class="col-sm-10">
                                    <!-- Use a plain input instead of {{ form.images }} -->
                                    <input type="file" id="id_images" name="images" multiple
                                           accept=".jpg,.jpeg,.png,.svg"
                                           class="sr-only-file">

                                    <!-- Drop area -->
                                    <div id="dropArea" class="dz-area" role="button" tabindex="0"
                                         aria-label="ছবি নির্বাচন করুন">
                                        <div class="dz-instructions">এখানে ছবি ফেলে দিন বা ক্লিক করে নির্বাচন করুন</div>
                                        <div id="previewGrid" class="dz-previews"></div>
                                    </div>

                                    <small class="text-muted d-block mt-2">
                                        JPG, JPEG, PNG, SVG — একাধিক ছবি যুক্ত করা যাবে।
                                    </small>
                                    <!-- server-side errors can be printed here if you want -->
                                </div>
                            </div>
                        {% endif %}

                        <div class="form-group row">
                            <label class="col-sm-2 col-form-label"></label>
                            <div class="col-sm-10">
                                <button type="submit" class="btn btn-block btn-primary">যুক্ত করুন</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- // ============  A) Use my location (Browser Geolocation) ============ -->
    <script>
        (function () {
            const btn = document.getElementById('btnUseMyLocation');
            if (!btn) return;

            btn.addEventListener('click', function () {
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser.');
                    return;
                }
                btn.disabled = true;
                btn.textContent = 'Locating...';

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude.toFixed(6);
                        const lng = pos.coords.longitude.toFixed(6);
                        const latInput = document.getElementById('id_latitude');
                        const lngInput = document.getElementById('id_longitude');
                        if (latInput) latInput.value = lat;
                        if (lngInput) lngInput.value = lng;
                        btn.disabled = false;
                        btn.textContent = 'Use my location';
                    },
                    (err) => {
                        console.error(err);
                        alert('Unable to retrieve your location. Please allow location permission or use the map picker.');
                        btn.disabled = false;
                        btn.textContent = 'Use my location';
                    },
                    {enableHighAccuracy: true, timeout: 10000, maximumAge: 0}
                );
            });
        })();
    </script>

    <!-- ============  B) Google Map Picker (with Places search) ============ -->
    <script>
        let map, marker, autocomplete, pickedLatLng;

        function initMapPicker() {
            const defaultCenter = {lat: 23.6850, lng: 90.3563}; // Bangladesh center
            map = new google.maps.Map(document.getElementById('mapPicker'), {
                zoom: 6,
                center: defaultCenter,
            });

            marker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                draggable: true
            });

            pickedLatLng = defaultCenter;

            // Click to move marker
            map.addListener('click', (e) => {
                marker.setPosition(e.latLng);
                pickedLatLng = {lat: e.latLng.lat(), lng: e.latLng.lng()};
            });

            // Drag marker to set point
            marker.addListener('dragend', () => {
                const pos = marker.getPosition();
                pickedLatLng = {lat: pos.lat(), lng: pos.lng()};
            });

            // Places autocomplete
            const input = document.getElementById('placeSearch');
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) return;
                map.panTo(place.geometry.location);
                map.setZoom(13);
                marker.setPosition(place.geometry.location);
                pickedLatLng = {lat: place.geometry.location.lat(), lng: place.geometry.location.lng()};
            });

            // When modal shows, trigger a map resize so it renders correctly
            $('#mapPickerModal').on('shown.bs.modal', function () {
                google.maps.event.trigger(map, 'resize');
                map.setCenter(marker.getPosition());
            });

            // Write back to inputs
            document.getElementById('btnUseSelectedPoint').addEventListener('click', function () {
                const latInput = document.getElementById('id_latitude');
                const lngInput = document.getElementById('id_longitude');
                if (latInput) latInput.value = pickedLatLng.lat.toFixed(6);
                if (lngInput) lngInput.value = pickedLatLng.lng.toFixed(6);
            });
        }
    </script>

    <!-- Load Google Maps JS with Places library; replace YOUR_KEY -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ map_key }}&libraries=places&callback=initMapPicker"
            async defer></script>

    <script>
        $(function () {
            // 1) Init Select2 once
            $('.select2').select2({
                width: '100%',
                placeholder: "Select an option",
                allowClear: true
            });

            // Existing select2 init and cached elements...
            const $country = $('#id_country');
            const $state = $('#id_state');
            const $division = $('#id_division');
            const $district = $('#id_district');
            const $subdistrict = $('#id_subdistrict');
            const $incidentType = $('#id_incident_type');
            const $actor = $('#id_involved_actor');

            const $wrapState = $('#wrap_state');
            const $wrapDivision = $('#wrap_division');
            const $wrapDistrict = $('#wrap_district');
            const $wrapSubdistrict = $('#wrap_subdistrict');

            function disable($el, on) {
                $el.prop('disabled', !!on).trigger('change.select2');
            }

            function show($w) {
                $w.show();
            }

            function hide($w) {
                $w.hide();
            }

            function clearSelect($el, placeholderText) {
                $el.empty().append(new Option(placeholderText || 'Select…', '', true, false))
                    .val(null).trigger('change.select2');
            }

            function fillSelect($el, items, placeholderText, valueKey, textKey) {
                const opts = [new Option(placeholderText || 'Select…', '', true, false)];
                items.forEach(it => opts.push(new Option(it[textKey], it[valueKey], false, false)));
                $el.empty().append(opts).val(null).trigger('change.select2');
            }

            function loadStatesByCountry(code) {
                clearSelect($state, 'স্টেট/রাজ্য');
                if (!code || code === 'BD') return; // no states for BD
                fetch(`/location/ajax/states/?country_code=${code}`)
                    .then(r => r.json())
                    .then(rows => fillSelect($state, rows, 'স্টেট/রাজ্য', 'id', 'name_bn'))
                    .catch(() => clearSelect($state, 'স্টেট/রাজ্য'));
            }

            function loadIncidentTypesByCountry(code) {
                clearSelect($incidentType, 'ঘটনার ধরণ');
                if (!code) return;
                fetch(`/incident/ajax/incident-types/?country_code=${code}`)
                    .then(r => r.json())
                    .then(rows => fillSelect($incidentType, rows, 'ঘটনার ধরণ', 'id', 'name_bn'))
                    .catch(() => clearSelect($incidentType, 'ঘটনার ধরণ'));
            }

            function loadActorsByCountry(code) {
                clearSelect($actor, 'জড়িত ব্যক্তি/গোষ্ঠী/সংগঠন');
                if (!code) return;
                fetch(`/incident/ajax/involved-actors/?country_code=${code}`)
                    .then(r => r.json())
                    .then(rows => fillSelect($actor, rows, 'জড়িত ব্যক্তি/গোষ্ঠী/সংগঠন', 'id', 'name_bn'))
                    .catch(() => clearSelect($actor, 'জড়িত ব্যক্তি/গোষ্ঠী/সংগঠন'));
            }

            function toggleByCountry() {
                const code = $country.val(); // "BD", "IN", "MM", "US", etc.

                // Always (re)load IncidentType & Actor for this country
                loadIncidentTypesByCountry(code);
                loadActorsByCountry(code);

                if (code === 'BD') {
                    hide($wrapState);
                    show($wrapDivision);
                    show($wrapDistrict);
                    show($wrapSubdistrict);
                    disable($state, true);
                    disable($division, false);
                    disable($district, false);
                    disable($subdistrict, false);
                    clearSelect($state, 'স্টেট/রাজ্য');
                } else if (code) {
                    show($wrapState);
                    hide($wrapDivision);
                    hide($wrapDistrict);
                    hide($wrapSubdistrict);
                    disable($state, false);
                    disable($division, true);
                    disable($district, true);
                    disable($subdistrict, true);
                    clearSelect($division, 'বিভাগ');
                    clearSelect($district, 'জেলা');
                    clearSelect($subdistrict, 'উপজেলা');
                    // Load states for the selected non-BD country
                    loadStatesByCountry(code);
                } else {
                    // Nothing selected → show everything (optional)
                    show($wrapState);
                    show($wrapDivision);
                    show($wrapDistrict);
                    show($wrapSubdistrict);
                    disable($state, false);
                    disable($division, false);
                    disable($district, false);
                    disable($subdistrict, false);
                }
            }

            // Existing division/district listeners (unchanged)
            $division.on('change', function () {
                const divisionId = $(this).val();
                clearSelect($district, 'জেলা');
                clearSelect($subdistrict, 'উপজেলা');
                if (!divisionId) return;
                fetch(`/location/ajax/get-districts/?division_id=${divisionId}`)
                    .then(r => r.json())
                    .then(rows => fillSelect($district, rows, 'জেলা', 'id', 'name_bn'))
                    .catch(() => clearSelect($district, 'জেলা'));
            });
            $district.on('change', function () {
                const districtId = $(this).val();
                clearSelect($subdistrict, 'উপজেলা');
                if (!districtId) return;
                fetch(`/location/ajax/subdistricts/?district_id=${districtId}`)
                    .then(r => r.json())
                    .then(rows => fillSelect($subdistrict, rows, 'উপজেলা', 'id', 'name_bn'))
                    .catch(() => clearSelect($subdistrict, 'উপজেলা'));
            });

            // Wire up & initialize
            $country.on('change', toggleByCountry);
            toggleByCountry();  // initial render

            // Optionally init flatpickr for datetime
            const dtId = '{{ form.date.id_for_label|escapejs }}';
            if (dtId && window.flatpickr) {
                flatpickr('#' + dtId, {enableTime: true, dateFormat: "Y-m-d\\TH:i"});
            }
        });
    </script>
{% endblock %}
